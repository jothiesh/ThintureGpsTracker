<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f1e41">

    <title>Thinture GPS</title>
    <link rel="icon" type="image/x-icon" href="/THINTURE_IMAGE/favicon.jpg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.all.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <!-- WebSocket Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tz-lookup@6.1.25/tz.min.js"></script>
<style>
    /* === Global === */
    html, body {
        overflow: hidden;
        margin: 0;
        padding: 0;
    }
    .mobile-header {
      display: none;
      background-color: #0f1e41;
      color: white;
      text-align: center;
      font-size: 20px;
      padding: 12px;
      font-weight: bold;
    }
    @media (max-width: 768px) {
      .mobile-header {
        display: block;
      }
    }
    @media (max-width: 768px) {
      #map {
        height: calc(100vh - 70px); /* Adjust if header height changes */
      }
    }
    @media (max-width: 768px) {
      #sidebar.active {
        right: 0 !important;
        top: 70px !important;
        height: calc(100vh - 70px);
        border-radius: 0;
      }
    }
    
    
    button, .custom-tab-btn {
      min-height: 42px;
    }
    @media (max-width: 576px) {
      .speed-alert-popup {
        width: 95vw;
        bottom: 15px;
        right: 2.5vw;
        left: auto;
        font-size: 14px;
      }
    }
    @media (max-width: 576px) {
      .vehicle-popup .label, .vehicle-popup .value {
        font-size: 12px;
      }
      .popup-header {
        font-size: 14px;
      }
      .custom-tab-btn {
        font-size: 12px;
        padding: 6px;
      }
    }

    /* === Toggle Button === */
    #toggleButton {
        position: fixed;
        top: 190px;
        right: 15px;
        z-index: 1100;
        background-color: #0f1e41;
        color: white;
        font-size: 18px;
        padding: 10px 14px;
        border-radius: 30px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    @media (max-width: 768px) {
        #toggleButton {
            top: 150px;
            right: 10px;
            font-size: 16px;
            padding: 8px 12px;
        }
    }

    /* === Sidebar === */
    #sidebar {
        position: fixed;
        top: 120px;
        right: -450px;
        width: 380px;
        height: 85vh;
        background: white;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.6);
        border-radius: 12px 0 0 12px;
        backdrop-filter: blur(1px);
        padding: 20px;
        color: #000;
        z-index: 1000;
        overflow-y: auto;
        overflow-x: hidden;
        transition: right 0.4s ease;
    }
    #sidebar.active {
        right: 0;
    }
    @media (max-width: 1200px) {
        #sidebar {
            top: 140px;
            right: -350px;
            height: 65vh;
            font-size: 0.9rem;
        }
    }
    @media (max-width: 768px) {
        #sidebar {
            width: 90vw;
            right: -100vw;
            top: 180px !important;
        }
    }
    #sidebar h2 {
        font-size: 24px;
        font-weight: bold;
        color: #00f7ff;
        margin-bottom: 20px;
        border-bottom: 2px solid #00f7ff;
        padding-bottom: 10px;
        text-shadow: 0 0 4px #00f7ff;
    }
    /* === Icon Click + Ripple Animation for SVG in Popups === */
    .clickable-icon {
        cursor: pointer;
        fill: darkblue;
        stroke: white;
        transition: transform 0.2s ease-in-out, fill 0.2s ease-in-out;
    }
    .clickable-icon:active {
        transform: scale(0.9);
        fill: #ff5733;
    }

    /* Ripple Effect Circle */
    .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 87, 51, 0.4);
        transform: scale(0);
        animation: ripple-animation 0.6s linear;
        pointer-events: none;
    }
    @keyframes ripple-animation {
        to {
            transform: scale(2);
            opacity: 0;
        }
    }

    /* === Search Bar === */
    #searchBar {
        background: rgba(255, 255, 255, 0.3);
        border: 1px solid darkslategrey;
        border-radius: 8px;
        padding: 8px;
        color: black;
        font-size: 10px;
        margin-bottom: 20px;
        width: 60%;
        box-shadow: 0 0 8px rgba(0, 219, 178, 0.2);
    }
    #searchBar::placeholder {
        color: #aaa;
    }

    /* === Table === */
    .table {
        font-size: 12px;
        border-radius: 10px;
        overflow: hidden;
        background-color: #fefefe;
    }
    .table th {
        background: #0f2041;
        color: white;
        text-align: center;
        padding: 2px;
    }
    .table td {
        background: white;
        text-align: center;
        padding: 2px;
    }

    /* === Map === */
    #map {
        margin-top: 10px;
        height: calc(120vh - 150px);
        position: relative;
    }

    /* === Popup === */
    
    .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
        font-weight: bold;
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 8px;
    }
    .close-btn {
        color: red;
        font-size: 18px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s ease;
    }
    .close-btn:hover {
        transform: scale(1.3);
    }
    .popup-content {
        font-size: 14px;
        color: #333;
        line-height: 1.6;
    }
    .popup-content strong {
        color: #555;
    }
    .popup-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    .popup-btn {
        flex: 1;
        border: none;
        padding: 8px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s ease;
        color: white;
    }
    .popup-btn.replay { background: #3498db; }
    .popup-btn.details { background: #2ecc71; }
    .popup-btn:hover { opacity: 0.8; }

    /* === Live Indicator === */
    .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        font-weight: bold;
        color: green;
    }
    .live-ripple {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(0, 255, 0, 0.4);
        animation: rippleEffect 1.5s infinite;
    }
    .live-ripple::after {
        animation-delay: 0.75s;
    }

    /* === Ripple Animation === */
    @keyframes rippleEffect {
        0% { transform: scale(0.5); opacity: 1; }
        100% { transform: scale(2.5); opacity: 0; }
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    @keyframes blink {
        0% { opacity: 1; }
        100% { opacity: 0.5; }
    }

    /* === Speed Alert Popup === */
    .speed-alert-popup {
        position: fixed;
        top: 355px;
        right: 608px;
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        animation: blink 1s infinite alternate;
    }
    @media (max-width: 768px) {
        .speed-alert-popup {
            top: auto;
            bottom: 80px;
            right: 10px;
            width: 90%;
            font-size: 14px;
            padding: 12px;
        }
    }

    /* === Map Switcher === */
    #mapSwitcher {
        position: fixed;
        top: 280px;
        right: 5px;
        z-index: 1000;
        padding: 5px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .map-button {
        background: transparent;
        border: none;
        color: #0f2041;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        width: 50px;
        transition: 0.3s ease;
    }
    .map-button:hover,
    .map-button.active {
        background-color: #0f2041;
        color: white;
    }

    /* === Tab Bar === */
    .custom-tab-bar {
        display: flex;
        background-color: #f0f0f0;
        border-bottom: 1px solid #ccc;
        border-radius: 8px 8px 0 0;
    }
    .custom-tab-btn {
        flex: 1;
        padding: 8px 12px;
        border: none;
        background-color: #f0f0f0;
        color: black;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .custom-tab-btn.active {
        background-color: #0f1e41;
        color: white;
    }
    .custom-tab-content {
        display: none;
        padding: 10px 0;
    }
    .custom-tab-content.active {
        display: block;
    }

    /* === Status Summary === */
    .status-summary {
        background-color: #f1f1f1;
        border-radius: 8px;
        padding: 10px 15px;
        margin-top: 10px;
        font-size: 14px;
    }
    .status-summary p {
        display: flex;
        justify-content: space-between;
        margin: 4px 0;
    }
    .status-summary span {
        cursor: pointer;
        color: #007bff;
    }
    .status-summary span:hover {
        text-decoration: underline;
    }
    @media (max-width: 768px) {
        .status-summary {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 0;
        }
    }

    /* === Status Colors === */
    #totalCount { color: black; font-weight: bold; }
    #runningCount { color: #2ecc71; font-weight: bold; }
    #idleCount { color: #f39c12; font-weight: bold; }
    #parkedCount { color: #3498db; font-weight: bold; }
    #lostCount { color: #e74c3c; font-weight: bold; }

@media (max-width: 768px) {
    #mobileCloseBtn {
        display: block;
    }
}
.refresh{
    position: absolute;
    top: 150px;
}
.gsm-bar {
    display: flex;
    align-items: center;
    gap: 6px;
}

.gsm-icon {
    display: flex;
    gap: 2px;
}

.gsm-icon .bar {
    width: 4px;
    height: 12px;
    background: #ccc;
    border-radius: 2px;
}

.gsm-icon .bar.filled {
    background: green;
}

.gsm-icon.low .bar.filled {
    background: red;
}

.gsm-icon.medium .bar.filled {
    background: orange;
}

.gsm-icon.high .bar.filled {
    background: green;
}

.gsm-strength-text {
    font-weight: bold;
    font-size: 13px;
}
.vehicle-popup .content {
    padding: 12px 16px;
    display: grid;
    grid-template-columns: auto 1fr;
    row-gap: 8px;
    column-gap: 12px;
    font-size: 13px;
}

.vehicle-popup .label {
    font-weight: 600;
    color: #444;
    display: flex;
    align-items: center;
    gap: 6px;
}

.vehicle-popup .value {
    text-align: left;
    font-weight: 500;
    color: #222;
    word-break: break-word;
}

.vehicle-popup .popup-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 13px;
    font-weight: bold;
    background: #f8f8f8;
    padding: 8px 12px;
    border-bottom: 2px solid #dc3545;
    color: #dc3545;
}

.vehicle-popup .popup-actions {
    margin-top: 12px;
    display: flex;
    justify-content: space-between;
    gap: 10px;
    padding: 10px;
}

.vehicle-popup .btn {
    flex: 1;
    border: none;
    border-radius: 6px;
    padding: 8px 0;
    font-size: 14px;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
    transition: background 0.3s;
}

.vehicle-popup .btn.details {
    background: #007bff;
}
.vehicle-popup .btn.playback {
    background: #28a745;
}
.vehicle-popup .btn:hover {
    opacity: 0.9;
}

.gsm-bar {
    display: flex;
    align-items: center;
    gap: 6px;
}
.gsm-icon {
    display: flex;
    gap: 2px;
}
.gsm-icon .bar {
    width: 4px;
    height: 12px;
    border-radius: 2px;
    background: #ccc;
}
.gsm-icon .bar.filled {
    background: green;
}
.gsm-strength-text {
    font-weight: 600;
    font-size: 12px;
    color: #555;
}
.popup-actions {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 12px;
    padding: 0 10px 10px;
}

.popup-actions .btn {
    flex: 1;
    padding: 8px 0;
    font-size: 14px;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    transition: background 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.btn-details {
    background-color: #007bff; /* Blue */
}

.btn-playback {
    background-color: #28a745; /* Green */
}

.popup-actions .btn:hover {
    opacity: 0.9;
}
/*popup vehicle detals*/
.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1050;
    display: none;
}

.popup-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    padding: 20px;
    z-index: 1060;
    display: none;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.popup-container.show {
    display: block;
}

.popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #2196f3;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.popup-table {
    width: 100%;
    font-size: 14px;
}
#vehicle-details-popup {
    position: absolute;
    background: #ffffff;
    border-radius: 10px;
    padding: 16px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    z-index: 9999;
    max-width: 90vw;
    width: 300px;
    font-size: 13px;
    display: none;
    transition: opacity 0.2s ease;
    border: 1px solid #ccc;
}

#vehicle-details-popup .popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    font-size: 15px;
    margin-bottom: 10px;
    color: #0f1e41;
    border-bottom: 1px solid #ccc;
    padding-bottom: 6px;
}

#vehicle-details-popup .popup-content {
    color: #333;
    line-height: 1.5;
}

#vehicle-details-popup .close-btn {
    color: red;
    cursor: pointer;
    font-size: 18px;
    font-weight: bold;
    padding-left: 12px;
    transition: transform 0.2s ease;
}

#vehicle-details-popup .close-btn:hover {
    transform: scale(1.2);
}

/* Mobile optimization */
@media (max-width: 576px) {
    #vehicle-details-popup {
        left: 50% !important;
        top: 20% !important;
        transform: translateX(-50%);
        width: 90vw;
    }
}
.map-layer-toggle {
  position: fixed;
  bottom: 105px;
  right: 15px;
  z-index: 9999;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3);
  padding: 12px;
  font-size: 14px;
  transition: all 0.3s ease;
}

#layerOptions {
  display: none;
  margin-top: 10px;
}

#layerToggleBtn {
  background-color: #0f1e41;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 14px;
  cursor: pointer;
}

#layerToggleBtn:hover {
  background-color: #1b2e63;
}

@media (max-width: 576px) {
  .map-layer-toggle {
    left: 50%;
    transform: translateX(-50%);
    width: 90vw;
    font-size: 13px;
  }
}
.last-received{
    font-size: 11px;
}

@media (max-width: 768px) {
    #toggleButton {
        transition: opacity 0.3s ease;
    }
}
.alertstatus{
    top: 190px !important;
}
.menu-button {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}
@media (max-width: 500px) {
  #searchInput {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  .menu-button {
    margin-left: auto;
    margin-top: 0.5rem;
  }
}
.swal2-offline-toast {
  width: 320px;
  font-size: 14px;
}

/* Device Details Popup */
.device-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    z-index: 1050;
    display: none;
    max-width: 400px;
    width: 90%;
}

.device-popup ul {
    list-style: none;
    padding: 0;
    margin: 10px 0;
}

.device-popup li {
    padding: 8px;
    border-bottom: 1px solid #eee;
}

.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
}

.pagination-controls button {
    padding: 5px 10px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
}

.pagination-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
</head>
<body>
    <header th:insert="navigation_dealer :: navbar_dealer"></header>
    
    <!-- TOGGLE BUTTON -->
    <button id="toggleButton" class="btn btn-primary" style="position: fixed; top: 190px;width: 50px; right: 10px; z-index: 9999;">
        ☰
    </button>

    <!-- Mobile Close Button -->
    <div id="mobileCloseBtn" style="text-align: right; margin: 5px 0; display: none;">
        <button class="btn btn-sm btn" style="font-size: 13px; color:red;" onclick="closeSidebar()">✖</button>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Speed Alert Popup -->
    <div id="speedAlertPopup" class="speed-alert-popup">
        <span class="close-btn" onclick="closeSpeedAlert()">×</span>
        <h4>🚨 Overspeed Alert</h4>
        <p><strong>Vehicle No:</strong> <span id="alertDeviceID"></span></p>
        <p><strong>Speed:</strong> <span id="alertSpeed"></span> km/h</p>
    </div>

    <!-- Alert Status Display -->
    <div class="alertstatus">
      🔌 Offline Alerts: <span id="offlineCount">0</span><br>
      🛑 Idle Alerts: <span id="idleCountAlert">0</span>
    </div>
    <ul id="offlineAlertList" class="list-group mt-2"></ul>
    <ul id="idleAlertList" class="list-group mt-2"></ul>

    <!-- Device Details Popup -->
    <div id="deviceDetailsPopup" class="device-popup">
        <div class="popup-header">
            <strong id="popup-title">Device Details</strong>
            <span class="close-btn" onclick="closeDevicePopup()">×</span>
        </div>
        <div class="popupcontent">
            <ul id="deviceList"></ul>
        </div>
        <div id="paginationControls" class="pagination-controls"></div>
    </div>

    <!-- Audio for alerts -->
    <audio id="overspeedAudio" src="/THINTURE_IMAGE/alertsspeed.mp3" preload="auto"></audio>

    <!-- Overlay for Modal -->
    <div id="popupOverlay" class="popup-overlay" onclick="closePopup()"></div>

    <!-- Vehicle Details Modal -->
    <div id="vehicleDetailsModal" class="popup-container">
        <div class="popup-header">
            <strong>Vehicle Details</strong>
            <span class="close-btn" onclick="closePopup()">×</span>
        </div>
        <div class="popup-content">
            <table id="vehicleDetailsTable" class="popup-table">
                <tr><td><strong>Vehicle No:</strong></td><td id="popup-deviceID">Loading...</td></tr>
                <tr><td><strong>Serial number:</strong></td><td id="popup-serialno">Loading...</td></tr>
                <tr><td><strong>Owner:</strong></td><td id="popup-ownerName">Loading...</td></tr>
                <tr><td><strong>Model:</strong></td><td id="popup-model">Loading...</td></tr>
                <tr><td><strong>SIM Number:</strong></td><td id="popup-simnumber">Loading...</td></tr>
                <tr><td><strong>Time Interval:</strong></td><td id="popup-timeinterval">Loading...</td></tr>
            </table>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-6 col-12" id="sidebar">
        <div id="mobileCloseBtn" style="text-align: right; margin: 5px 0; display: none;">
            <button class="btn btn-sm btn" style="font-size: 13px; color:red" onclick="closeSidebar()">✖</button>
        </div>
        <div class="custom-tab-bar">
            <button class="custom-tab-btn active" onclick="showSidebarTab('devicesTab', this)">Device</button>
            <button class="custom-tab-btn" onclick="showSidebarTab('alertsTab', this)">Alerts</button>
            <button class="custom-tab-btn" onclick="showSidebarTab('activeTab', this)">Active/Inactive</button>
        </div>
        
        <!-- Device Tab Content -->
        <div id="devicesTab" class="custom-tab-content active">
            <div class="d-flex flex-column p-2" style="gap: 10px;">
              <div class="d-flex justify-content-between align-items-center flex-wrap">
                <input type="text" id="searchBar" placeholder="Search by Device ID" class="form-control mb-2">
              </div>

              <div class="table-responsive">
                <table class="table table-bordered table-sm text-center mb-0">
                  <thead class="table-dark">
                    <tr>
                      <th>Status</th>
                      <th>Vehicle No</th>
                      <th>Time Interval</th>
                      <th>Last Upload</th>
                      <th>Select Device</th>
                    </tr>
                  </thead>
                  <tbody id="trackerTableBody">
                    <!-- dynamically injected -->
                  </tbody>
                </table>
                <div id="sidebarPagination" class="pagination-controls mt-2"></div>
              </div>
            </div>
        </div>

        <!-- Alerts Tab Content -->
        <div id="alertsTab" class="custom-tab-content">
            <div class="position-fixed top-150px end-0 m-3 z-3 text-end">
                <label for="muteToggleBtn" class="me-2 fw-bold text-black">🔊 Alert Sound</label>
                <button id="muteToggleBtn" class="btn btn-sm btn-outline-black">🔇 Mute</button>
            </div>

            <div class="refresh end-0 m-3 z-3 text-end">
                <label for="RefershToggleBtn" class="me-2 fw-bold text-black">🔄 Refresh</label>
                <button class="btn btn-sm btn-outline-black" onclick="refreshAll()">🔄 Refresh</button>
            </div>
        </div>

        <!-- Active/Inactive Tab Content -->
        <div id="activeTab" class="custom-tab-content">
            <div class="status-summary">
                <p><strong>Total Vehicles:</strong> 
                    <span id="totalCount" onclick="fetchDevicesByStatus('total')">0</span>
                </p>
                <p><strong>Running:</strong> 
                    <span id="runningCount" onclick="fetchDevicesByStatus('running')">0</span>
                </p>
                <p><strong>Idle:</strong> 
                    <span id="idleCount" onclick="fetchDevicesByStatus('idle')">0</span>
                </p>
                <p><strong>Parked:</strong> 
                    <span id="parkedCount" onclick="fetchDevicesByStatus('parked')">0</span>
                </p>
                <p><strong>Offline:</strong> 
                    <span id="lostCount" onclick="fetchDevicesByStatus('lost')">0</span>
                </p>
            </div>
            <ul id="offlineAlertListTab"></ul>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Add before your main <script> -->
    <script src="https://cdn.jsdelivr.net/npm/tz-lookup@6.1.25/tz.min.js"></script>
    
<script>
// =========== ADD CONFIGURATION OBJECT ===========
const CONFIG = {
    USER: {
        id: null,
        username: null,
        role: null
    },
    allowedDeviceIDs: [], // Will be populated from API
    debugMode: false
};

// =========== ENHANCED VehicleTracker CLASS ===========
class VehicleTracker {
    constructor(mapElementId) {
        const mapElement = document.getElementById(mapElementId);
        if (!mapElement) {
            console.error("❌ Map element not found! Make sure the ID is correct.");
            return;
        }

        this.map = L.map(mapElementId, {
            zoomControl: false
        }).setView([13.07757, 77.55928], 15);

        if (!this.map) {
            console.error("❌ Map failed to initialize.");
            return;
        }

        // OSM English layer
        const osmEnglish = L.tileLayer('https://{s}.tile.openstreetmap.fr/osm-en/{z}/{x}/{y}.png', {
            maxZoom: 15,
            attribution: '&copy; OpenStreetMap contributors'
        });

        // Carto Light layer
        const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        });

        // Add default layer to map
        osmEnglish.addTo(this.map);

        this.markers = {};

        // =========== INITIALIZE SESSION AND PERMISSIONS ===========
        this.initializeSession();
    }

    // =========== ADD SESSION INITIALIZATION METHOD ===========
    async initializeSession() {
        try {
            console.log('🔐 Fetching user session...');
            
            // Fetch session info
            const sessionRes = await fetch('/api/devices/session-role');
            if (!sessionRes.ok) throw new Error(`Session fetch failed: ${sessionRes.status}`);
            
            const session = await sessionRes.json();
            
            // Extract user info
            CONFIG.USER.username = session.username;
            CONFIG.USER.id = session.id;
            
            // Extract role from authorities
            const authorityObj = session.authorities[0];
            let role = '';
            
            if (typeof authorityObj === 'string') {
                role = authorityObj.replace('ROLE_', '').toLowerCase();
            } else if (typeof authorityObj === 'object' && authorityObj.authority) {
                role = authorityObj.authority.replace('ROLE_', '').toLowerCase();
            }
            
            CONFIG.USER.role = role;
            
            console.log(`✅ Session loaded: ${CONFIG.USER.username} | Role: ${CONFIG.USER.role} | ID: ${CONFIG.USER.id}`);
            
            // Fetch allowed devices
            const devicesRes = await fetch('/api/devices/my-devices');
            if (!devicesRes.ok) throw new Error(`Devices fetch failed: ${devicesRes.status}`);
            
            const deviceIDs = await devicesRes.json();
            CONFIG.allowedDeviceIDs = deviceIDs.map(d => String(d).trim().toUpperCase());
            
            console.log(`✅ Allowed Devices: [${CONFIG.allowedDeviceIDs.join(', ')}]`);
            
            // Now fetch initial vehicle data (filtered)
            this.fetchVehicleData();
            
            // Initialize WebSocket with role-based subscription
            this.initWebSocket();
            
        } catch (error) {
            console.error('❌ Session initialization failed:', error);
            // Fallback to normal operation without filtering
            this.fetchVehicleData();
            this.initWebSocket();
        }
    }

    // =========== MODIFY fetchVehicleData TO FILTER ===========
    fetchVehicleData() {
        fetch('/api/vehicle/last/latests-locations/all')
            .then(res => res.json())
            .then(data => {
                // =========== FILTER BY ALLOWED DEVICES ===========
                const filteredData = CONFIG.allowedDeviceIDs.length > 0 
                    ? data.filter(vehicle => {
                        const deviceId = (vehicle.deviceId || vehicle.deviceID || '').trim().toUpperCase();
                        return CONFIG.allowedDeviceIDs.includes(deviceId);
                    })
                    : data;
                
                console.log(`📍 Showing ${filteredData.length} of ${data.length} vehicles (filtered by role)`);
                
                filteredData.forEach(vehicle => {
                    const lat = parseFloat(vehicle.latitude);
                    const lng = parseFloat(vehicle.longitude);
                    const speed = parseFloat(vehicle.speed);
                    const deviceId = vehicle.deviceId || vehicle.deviceID || "N/A";

                    if (!isNaN(lat) && !isNaN(lng)) {
                        // 🔄 Call the existing marker creation method
                        this.createOrUpdateMarker(vehicle);

                        // 🔔 Trigger speed alert
                        if (speed > 140 && deviceId !== "N/A") {
                            playSpeedAlert(deviceId, speed);
                        }
                        
                        const speedLimit = parseFloat(vehicle.speedLimit) || 140;
                        if (speed > speedLimit && deviceId !== "N/A") {
                            playSpeedAlert(deviceId, speed);
                        }
                    }
                });
            });
    }

    updateMapMarkers(vehicles) {
        vehicles.forEach(vehicle => this.createOrUpdateMarker(vehicle));
    }

    createOrUpdateMarker(vehicle, isLive) {
        if (!this.map) {
            console.error("❌ Map object is NULL. Cannot create marker.");
            return;
        }

        function formatUtcTime(timestamp) {
            const dateObj = new Date(timestamp);
            return dateObj.toISOString().replace("T", " ").substring(0, 19);
        }

        const deviceId = vehicle.deviceId || vehicle.deviceID || "Unknown";
        const latitude = parseFloat(vehicle.latitude);
        const longitude = parseFloat(vehicle.longitude);
        const course = parseFloat(vehicle.course) || 0;

        if (!deviceId || deviceId.toLowerCase() === "null" || isNaN(latitude) || isNaN(longitude)) {
            console.warn(`⛔ Skipping marker for invalid device (${deviceId})`);
            return;
        }

        const speed = vehicle.speed || 0;
        const ignitionStatus = vehicle.ignition
            ? vehicle.ignition.toUpperCase() === "IGON"
                ? "ON"
                : vehicle.ignition.toUpperCase() === "IGOFF"
                    ? "OFF"
                    : "Unknown"
            : "Unknown";

        let vehicleStatus = (vehicle.vehicleStatus || "Unknown").toUpperCase();

        // ✅ If live data, TRUST the status
        if (!isLive) {
            // Always recompute status based on timestamp
            const [run, park, idle] = (vehicle.timeIntervals || "0,0,0").split(',').map(x => +x || 0);
            const timestamp = new Date(vehicle.timestamp).getTime();
            const elapsedSec = (Date.now() - timestamp) / 1000;

            if ((vehicleStatus === "RUNNING" || vehicleStatus === "MOVING") && run > 0) {
                if (elapsedSec > run) vehicleStatus = "OFFLINE";
            } else if (vehicleStatus === "PARKED" && park > 0) {
                if (elapsedSec > park) vehicleStatus = "OFFLINE";
            } else if (vehicleStatus === "IDLE" && idle > 0) {
                if (elapsedSec > idle) vehicleStatus = "OFFLINE";
            } else {
                vehicleStatus = "OFFLINE";
            }
        }

        const formattedDateTime = formatUtcTime(vehicle.timestamp);
        const isLiveNow = !!isLive;

        const vehicleIcon = this.getVehicleIcon(course, vehicle.ignition, vehicleStatus);

        const gsmStrength = parseInt(vehicle.gsmStrength) || 0;
        let gsmLevel = "Unknown", gsmColor = "gray";

        if (gsmStrength === 0) {
            gsmLevel = "No Signal";
            gsmColor = "darkgray";
        } else if (gsmStrength >= 1 && gsmStrength <= 9) {
            gsmLevel = "Poor";
            gsmColor = "red";
        } else if (gsmStrength >= 10 && gsmStrength <= 14) {
            gsmLevel = "Moderate";
            gsmColor = "orange";
        } else if (gsmStrength >= 15 && gsmStrength <= 19) {
            gsmLevel = "Good";
            gsmColor = "yellowgreen";
        } else if (gsmStrength >= 20 && gsmStrength <= 30) {
            gsmLevel = "Excellent";
            gsmColor = "green";
        } else if (gsmStrength >= 31 && gsmStrength <= 99) {
            gsmLevel = "Perfect";
            gsmColor = "limegreen";
        }

        const popupContent = `
            <div class="vehicle-popup">
                <div class="popup-header">
                    ${isLiveNow
                        ? '<span class="live-indicator"><span class="live-ripple"></span> LIVE</span>'
                        : `<span class="last-received">🔴 Last Received: ${formattedDateTime}</span>`}
                </div>
                <div class="content">
                    <div class="label"><i class="fas fa-car"></i>Vehicle No</div>
                    <div class="value">${deviceId}</div>
                    <div class="label"><i class="fas fa-clock"></i>Time Interval</div>
                    <div class="value">${vehicle.timeIntervals}</div>
                    <div class="label"><i class="fas fa-map-pin"></i>Latitude</div>
                    <div class="value">${latitude.toFixed(5)}</div>
                    <div class="label"><i class="fas fa-map-pin"></i>Longitude</div>
                    <div class="value">${longitude.toFixed(5)}</div>
                    <div class="label"><i class="fas fa-rocket"></i>Speed</div>
                    <div class="value">${speed} km/h</div>
                    <div class="label"><i class="fas fa-key"></i>Ignition</div>
                    <div class="value" style="color:${ignitionStatus === 'ON' ? '#28a745' : '#e54d4d'}">${ignitionStatus}</div>
                    <div class="label"><i class="fas fa-check-square"></i>Status</div>
                    <div class="value">${vehicleStatus}</div>
                    <div class="label"><i class="fas fa-signal"></i>GSM</div>
                    <div class="value gsm-bar">
                        <span class="gsm-icon ${gsmLevel.toLowerCase()}">
                            ${generateGSMBars(gsmStrength)}
                        </span>
                        <span class="gsm-strength-text" style="color:${gsmColor}">
                            ${gsmLevel} (${gsmStrength})
                        </span>
                    </div>
                </div>
                <div class="popup-actions">
                    <button class="btn btn-details" onclick="showVehicleDetails('${deviceId}', event)">Details</button>
                    <button class="btn btn-playback" onclick="navigateToReplay('${deviceId}')">
                        <i class="fas fa-backward"></i> Playback
                    </button>
                </div>
            </div>
        `;

        if (this.markers[deviceId]) {
            this.markers[deviceId]
                .setLatLng([latitude, longitude])
                .setPopupContent(popupContent)
                .setIcon(vehicleIcon);
        } else {
            const marker = L.marker([latitude, longitude], { icon: vehicleIcon });
            marker.bindPopup(popupContent);
            marker.addTo(this.map);
            this.markers[deviceId] = marker;
        }
    }

    // Helper function for speed color classes
    getSpeedClass(speed) {
        if (speed < 2) return "speed-low";
        if (speed < 30) return "speed-medium";
        return "speed-high";
    }

    // Helper function for vehicle status classes
    getStatusClass(status) {
        switch (status.toLowerCase()) {
            case "online": return "status-online";
            case "offline": return "status-offline";
            case "idle": return "status-idle";
            case "moving": return "status-moving";
            default: return "status-unknown";
        }
    }

    getVehicleIcon(course, ignition, vehicleStatus) {
        const basePath = '/THINTURE_IMAGE/car';
        let color = 'green'; // Default color

        // ✅ Change color based on vehicle status
        switch (vehicleStatus.toUpperCase()) {
            case 'PARKED': case 'IDLE': color = 'orange'; break;
            case 'RUNNING': color = 'green'; break;
            case 'OFFLINE': case 'CONNECTION LOST': color = 'red'; break;
        }

        console.log(`🚗 Vehicle Status: ${vehicleStatus}, Color Set To: ${color}`);

        const imagePath = `${basePath}/${color}/car0.png`;

        return L.divIcon({
            html: `<img src="${imagePath}" 
                        style="transform: rotate(${course}deg); width: 35px; height: 35px;">`,  // ✅ Instantly Rotates
            className: 'custom-icon',
            iconSize: [35, 35],
            iconAnchor: [17, 17],  // Center the icon
            popupAnchor: [0, -15]
        });
    }

    zoomToVehicle(deviceId, latitude, longitude) {
        if (!this.map) {
            console.error("❌ Map not initialized.");
            return;
        }
        if (latitude == null || longitude == null) {
            console.error(`❌ Missing coordinates for device ${deviceId}`);
            return;
        }

        const maxZoom = this.map.getMaxZoom() || 20;
        this.map.setView([latitude, longitude], maxZoom);

        // 🔍 Temporarily hide other markers
        Object.entries(this.markers).forEach(([id, marker]) => {
            if (id !== deviceId && marker._icon) marker._icon.style.display = "none";
        });

        const marker = this.markers[deviceId];
        if (marker) {
            marker.openPopup();
            const icon = marker._icon;
            if (icon) {
                icon.classList.add("highlight-marker");
                setTimeout(() => {
                    icon.classList.remove("highlight-marker");
                    Object.values(this.markers).forEach(m => {
                        if (m._icon) m._icon.style.display = "";
                    });
                }, 8000);
            }
        }

        // 🔒 Close sidebar
        const sidebar = document.getElementById("sidebar");
        const toggleButton = document.getElementById("toggleButton");

        if (sidebar) sidebar.classList.remove("active");
        if (toggleButton) toggleButton.classList.remove("active");

        // ✅ Fix toggle visibility after sidebar is closed
        updateToggleVisibility();
    }

    // =========== MODIFY initWebSocket TO USE ROLE-BASED TOPIC ===========
    initWebSocket() {
        setTimeout(() => {
            // 1️⃣ Open SockJS connection to your endpoint
            const socket = new SockJS('/gs-guide-websocket');
            const stompClient = Stomp.over(socket);

            // 2️⃣ Connect STOMP over the SockJS connection
            stompClient.connect({}, () => {
                console.log('✅ WebSocket connected.');

                // =========== ROLE-BASED TOPIC SUBSCRIPTION ===========
                let topic = '/topic/location-updates';
                
                // If we have role and ID, use specific topic
                if (CONFIG.USER.role && CONFIG.USER.id) {
                    topic = `/topic/location-updates/${CONFIG.USER.role}/${CONFIG.USER.id}`;
                    console.log(`📡 Subscribing to role-based topic: ${topic}`);
                } else {
                    console.log(`📡 Subscribing to general topic: ${topic}`);
                }

                stompClient.subscribe(topic, (message) => {
                    try {
                        const vehicleData = JSON.parse(message.body);
                        if (!vehicleData) return;

                        console.log("🔍 WebSocket data received:", vehicleData);
                        console.log("🔍 vehicleData.deviceId:", vehicleData.deviceId);
                        console.log("🔍 vehicleData.deviceID:", vehicleData.deviceID);

                        // Try to normalize:
                        const deviceId = (vehicleData.deviceId || vehicleData.deviceID || '').trim().toUpperCase();
                        vehicleData.deviceId = deviceId;

                        // =========== CLIENT-SIDE FILTERING ===========
                        if (CONFIG.allowedDeviceIDs.length > 0 && !CONFIG.allowedDeviceIDs.includes(deviceId)) {
                            console.log(`🚫 Device not in allowed list: ${deviceId}`);
                            return;
                        }

                        console.log("✅ Normalized and allowed deviceId:", deviceId);

                        vehicleData.isLiveEvent = true;

                        this.createOrUpdateMarker(vehicleData, true);
                        updateSidebarRow(vehicleData);

                    } catch (error) {
                        console.error('WebSocket message error:', error);
                    }
                });

            }, (error) => {
                console.error('❌ WebSocket connection error:', error);
                // 6️⃣ If error, try reconnecting after 5 sec
                setTimeout(() => this.initWebSocket(), 5000);
            });

        }, 2000); // 2-second initial delay
    }
}

function navigateToReplay(deviceId) {
    window.location.href = `/superadmin/replay?deviceId=${encodeURIComponent(deviceId)}`;
}

document.addEventListener('DOMContentLoaded', () => {
    window.vehicleTracker = new VehicleTracker('map');

    // Start initial data loading + auto-refresh
    autoRefreshData();
    setInterval(autoRefreshData, 30000);

    // Toggle button setup
    document.getElementById("toggleButton").addEventListener("click", () => {});

    fetch('/api/vehicle/last/latests-locations/all')
        .then(res => res.json())
        .then(data => {
            // =========== FILTER BY ALLOWED DEVICES ===========
            const filteredData = CONFIG.allowedDeviceIDs.length > 0 
                ? data.filter(v => {
                    const deviceId = (v.deviceId || v.deviceID || '').trim().toUpperCase();
                    return CONFIG.allowedDeviceIDs.includes(deviceId);
                })
                : data;

            if (filteredData.length > 0) {
                window.updateSidebarTable(filteredData);
            } else {
                document.getElementById("trackerTableBody").innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">No data</td>
                    </tr>
                `;
            }
        })
        .catch(err => {
            console.error('Failed to fetch vehicle data:', err);
        });
});

// Utility to format ISO timestamps to "YYYY-MM-DD hh:mm:ss"
function formatUtcTime(ts) {
    const d = new Date(ts);
    return d.toISOString().replace('T', ' ').substr(0, 19);
}

// Completely rebuilds the sidebar table
window.updateSidebarTable = function(vehicles) {
    const now = Date.now();
    const tbody = document.getElementById('trackerTableBody');

    // Build each row
    const rowsHtml = vehicles
        .filter(v => v.deviceId && v.deviceId.toLowerCase() !== 'null')
        .map(v => {
            const statusRaw = (v.vehicleStatus || '').toUpperCase();
            const [run, park, idle] = (v.timeIntervals || '0,0,0')
                .split(',').map(n => Math.max(0, +n));
            const ts = new Date(v.timestamp).getTime();
            const elapsed = isNaN(ts) ? Infinity : (now - ts) / 1000;

            let displayStatus = 'OFFLINE';
            if ((statusRaw === 'RUNNING' || statusRaw === 'MOVING') && run > 0 && elapsed <= run) {
                displayStatus = statusRaw;
            } else if (statusRaw === 'PARKED' && park > 0 && elapsed <= park) {
                displayStatus = 'PARKED';
            } else if (statusRaw === 'IDLE' && idle > 0 && elapsed <= idle) {
                displayStatus = 'IDLE';
            }

            return `
                <tr data-device="${v.deviceId}">
                    <td>${displayStatus}</td>
                    <td>${v.deviceId}</td>
                    <td><small>${v.timeIntervals || '0,0,0'}</small></td>
                    <td>${formatUtcTime(v.timestamp)}</td>
                    <td>
                        <button onclick="zoomEffect(event,'${v.deviceId}',${parseFloat(v.latitude)||0},${parseFloat(v.longitude)||0})">
                            Zoom
                        </button>
                    </td>
                </tr>
            `;
        })
        .join('');

    // **Fix**: colspan must match your 5 columns
    tbody.innerHTML = rowsHtml ||
        `<tr><td colspan="5" class="text-center text-muted">No vehicles</td></tr>`;

    // re-apply pagination if enabled
    if (typeof paginateSidebarTable === 'function') paginateSidebarTable();
};

// Incrementally updates one row on live WebSocket messages
window.updateSidebarRow = function(vehicle) {
    const tr = document.querySelector(
        `#trackerTableBody tr[data-device="${vehicle.deviceId}"]`
    );
    if (!tr) return;

    const now = Date.now();
    const ts = new Date(vehicle.timestamp).getTime();
    const elapsed = isNaN(ts) ? Infinity : (now - ts) / 1000;
    const statusRaw = (vehicle.vehicleStatus || '').toUpperCase();
    const [run, park, idle] = (vehicle.timeIntervals || '0,0,0')
        .split(',').map(n => Math.max(0, +n));

    let displayStatus = 'OFFLINE';
    if ((statusRaw === 'RUNNING' || statusRaw === 'MOVING') && run > 0 && elapsed <= run) {
        displayStatus = statusRaw;
    } else if (statusRaw === 'PARKED' && park > 0 && elapsed <= park) {
        displayStatus = 'PARKED';
    } else if (statusRaw === 'IDLE' && idle > 0 && elapsed <= idle) {
        displayStatus = 'IDLE';
    }

    // Update Status (cell 0) and Last Upload (cell 3)
    tr.cells[0].textContent = displayStatus;
    tr.cells[3].textContent = formatUtcTime(vehicle.timestamp);

    // brief flash highlight
    tr.classList.add('bg-success','bg-opacity-25');
    setTimeout(() => tr.classList.remove('bg-success','bg-opacity-25'), 800);
};

// =========== MODIFY autoRefreshData TO FILTER ===========
function autoRefreshData() {
    fetch('/api/vehicle/last/latests-locations/all')
        .then(response => response.json())
        .then(data => {
            let runningCount = 0, idleCount = 0, parkedCount = 0, lostCount = 0;
            const now = Date.now();

            const validVehicles = data.filter(vehicle => {
                const lat = parseFloat(vehicle.latitude);
                const lng = parseFloat(vehicle.longitude);
                const deviceId = (vehicle.deviceId || '').trim().toUpperCase();
                
                // =========== CHECK IF DEVICE IS ALLOWED ===========
                const isAllowed = CONFIG.allowedDeviceIDs.length === 0 || CONFIG.allowedDeviceIDs.includes(deviceId);
                
                return (
                    !isNaN(lat) && !isNaN(lng) &&
                    deviceId && deviceId.toLowerCase() !== 'null' &&
                    isAllowed
                );
            }).map(vehicle => {
                const status = (vehicle.vehicleStatus || "").toUpperCase();
                const [run, park, idle] = (vehicle.timeIntervals || '0,0,0').split(',').map(x => +x || 0);
                const timestamp = new Date(vehicle.timestamp).getTime();
                const elapsedSec = (now - timestamp) / 1000;

                let isOffline = false;

                if ((status === "RUNNING" || status === "MOVING") && run > 0) {
                    if (elapsedSec > run) isOffline = true;
                } 
                else if (status === "PARKED" && park > 0) {
                    if (elapsedSec > park) isOffline = true;
                } 
                else if (status === "IDLE" && idle > 0) {
                    if (elapsedSec > idle) isOffline = true;
                } 
                else {
                    // Only mark offline if no valid intervals AND older than 60s
                    if (elapsedSec > 60) isOffline = true;
                }

                vehicle.vehicleStatus = isOffline ? "Offline" : status;

                // Update counters
                switch (vehicle.vehicleStatus) {
                    case "RUNNING": runningCount++; break;
                    case "IDLE": idleCount++; break;
                    case "PARKED": parkedCount++; break;
                    case "Offline": lostCount++; break;
                }

                const parsedGSM = parseInt(vehicle.gsmStrength);
                vehicle.gsmStrength = isNaN(parsedGSM) ? 0 : parsedGSM;
                vehicle.utcFormattedTime = formatUtcTime(vehicle.timestamp);

                return vehicle;
            });

            // 🧮 Update counters
            document.getElementById("totalCount").textContent = validVehicles.length;
            document.getElementById("runningCount").textContent = runningCount;
            document.getElementById("idleCount").textContent = idleCount;
            document.getElementById("parkedCount").textContent = parkedCount;
            document.getElementById("lostCount").textContent = lostCount;

            // 🗺️ Update map & sidebar
            window.vehicleTracker.updateMapMarkers(validVehicles);
            updateSidebarTable(validVehicles);

            // 💾 Store timestamps
            window.deviceTimestamps = {};
            validVehicles.forEach(v => {
                window.deviceTimestamps[v.deviceId] = v.timestamp;
            });
        })
        .catch(err => console.error('🚨 Error fetching vehicle data:', err));
}

// ✅ Run on load

</script>

<script>
function navigateToReplay(deviceId) {
    if (!deviceId) {
        alert("Device ID is required to navigate to the replay page.");
        return;
    }
    window.location.href = `/superadmin/replay?deviceId=${encodeURIComponent(deviceId)}`;
}
</script>

<script>
// ✅ Function to fetch and display vehicle details in a popup
async function showVehicleDetails(deviceID, event) {
    if (!deviceID) {
        console.error("❌ Device ID is missing!");
        alert("❌ No Device ID found!");
        return;
    }

    console.log("🚀 Fetching details for Device ID:", deviceID);

    try {
        const response = await fetch(`/api/details/${deviceID}`);
        if (!response.ok) {
            throw new Error("❌ Server returned error " + response.status);
        }

        const vehicle = await response.json();
        console.log("📡 Vehicle Details Received:", vehicle);

        if (!vehicle || Object.keys(vehicle).length === 0) {
            alert("❌ No data found for this vehicle!");
            return;
        }

        // Check if popup exists, create if not
        let detailsPopup = document.getElementById("vehicle-details-popup");
        if (!detailsPopup) {
            detailsPopup = document.createElement("div");
            detailsPopup.id = "vehicle-details-popup";
            document.body.appendChild(detailsPopup);
        }

        // Populate popup with vehicle details
        detailsPopup.innerHTML = `
            <div class="popup-header">
                <strong>Vehicle Details</strong>
                <span class="close-btn" onclick="closeVehiclePopup()">×</span>
            </div>
            <div class="popup-content">
               
                <strong>Vehicle Number:</strong> ${vehicle.deviceID || "N/A"} <br>
                <strong>Owner:</strong> ${vehicle.ownerName || "N/A"} <br>
                <strong>Total Distance:</strong> ${vehicle.totalDistance || "N/A"} km <br>
               
                <strong>Driver RFID:</strong> ${vehicle.driverRFID || "N/A"} <br>
                <strong>GSM Strength:</strong> ${vehicle.gsmStrength || "N/A"} <br>
                <strong>IMEI:</strong> ${vehicle.imei || "N/A"} <br>
                <strong>Vehicle Model:</strong> ${vehicle.model || "N/A"} <br>
            </div>
        `;

        // Show popup near clicked button
        detailsPopup.style.display = "block";
        const button = event.target;
        const rect = button.getBoundingClientRect();
        detailsPopup.style.top = `${rect.top + window.scrollY + 40}px`;
        detailsPopup.style.left = `${rect.left + window.scrollX}px`;

        // Add event listener to close when clicking outside
        setTimeout(() => {
            document.addEventListener("click", outsideClickListener);
        }, 100);

    } catch (error) {
        console.error("🚨 Error fetching vehicle details:", error);
        alert("⚠️ Error fetching data. Check console for details.");
    }
}

// Function to close the popup
function closeVehiclePopup() {
    let detailsPopup = document.getElementById("vehicle-details-popup");
    if (detailsPopup) {
        detailsPopup.style.display = "none";
    }
}

// Click outside listener to close popup
function outsideClickListener(event) {
    let detailsPopup = document.getElementById("vehicle-details-popup");
    if (detailsPopup && !detailsPopup.contains(event.target)) {
        closeVehiclePopup();
        document.removeEventListener("click", outsideClickListener);
    }
}

// Function to close the popup
function closeVehiclePopup() {
    const popup = document.getElementById("vehicle-details-popup");
    if (popup) {
        popup.style.display = "none";
        document.removeEventListener("click", outsideClickListener); // Remove event listener
    }
}

// Function to detect outside click
function outsideClickListener(event) {
    const popup = document.getElementById("vehicle-details-popup");
    if (popup && event.target !== popup && !popup.contains(event.target)) {
        closeVehiclePopup();
    }
}

document.getElementById("searchBar").addEventListener("input", function() {
    const searchValue = this.value.toLowerCase();
    const rows = document.querySelectorAll("#trackerTableBody tr");

    rows.forEach(row => {
        const deviceId = row.cells[1]?.textContent.toLowerCase() || ""; // Assuming device ID is in the 2nd column (index 1)
        if (deviceId.includes(searchValue)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});

// Speed alert popup logic
function playSpeedAlert(deviceId, speed) {
    showSpeedAlert(deviceId, speed);

    const audio = document.getElementById("overspeedAudio");
    if (audio) {
        audio.currentTime = 0;
        audio.play().catch(err => {
            console.warn("⚠️ Audio play failed:", err);
        });
    }
}

function showSpeedAlert(deviceId, speed) {
    document.getElementById("alertDeviceID").textContent = deviceId;
    document.getElementById("alertSpeed").textContent = speed;

    const popup = document.getElementById("speedAlertPopup");
    popup.style.display = "block";

    // ⏱️ Auto-close after 5 seconds
    setTimeout(() => {
        popup.style.display = "none";
    }, 3000);
}

function closeSpeedAlert() {
    document.getElementById("speedAlertPopup").style.display = "none";
}

// =========== MODIFY autoRefreshSidebar TO FILTER ===========
function autoRefreshSidebar() {
    fetch('/api/vehicle/last/latests-locations/all')
        .then(res => res.json())
        .then(data => {
            if (Array.isArray(data) && data.length > 0) {
                // =========== FILTER BY ALLOWED DEVICES ===========
                const filteredData = CONFIG.allowedDeviceIDs.length > 0 
                    ? data.filter(v => {
                        const deviceId = (v.deviceId || v.deviceID || '').trim().toUpperCase();
                        return CONFIG.allowedDeviceIDs.includes(deviceId);
                    })
                    : data;
                    
                window.updateSidebarTable(filteredData);
            } else {
                document.getElementById("trackerTableBody").innerHTML = `
                    <tr><td colspan="4" class="text-center text-muted">No devices found</td></tr>
                `;
            }
        });
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let currentLayer;
    let mapLayers = {
        "osm": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }),
        "googleSatellite": L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            attribution: '&copy; Google Satellite'
        }),
        "googleRoadMap": L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            attribution: '&copy; Google '
        }),
        "googleHybrid": L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            attribution: '&copy; Google Hybrid'
        })
    };

    function switchLiveMap(mapType) {
        const nextLayer = mapLayers[mapType];

        if (!nextLayer || typeof nextLayer.addTo !== "function") {
            console.error("❌ Invalid map layer:", mapType, nextLayer);
            return;
        }

        if (currentLayer && typeof currentLayer.remove === "function") {
            window.vehicleTracker.map.removeLayer(currentLayer);
        }

        currentLayer = nextLayer;
        currentLayer.addTo(window.vehicleTracker.map);

        // Update button UI
        document.querySelectorAll(".map-button").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`.map-button[data-map="${mapType}"]`).classList.add("active");
    }

    // Initialize map with OSM by default
    currentLayer = mapLayers["osm"];
    currentLayer.addTo(window.vehicleTracker.map);

    // Assign switching function globally
    window.switchLiveMap = switchLiveMap;
});

function closeSidebar() {
    const sidebar = document.getElementById("sidebar");
    const toggleButton = document.getElementById("toggleButton");
    const mobileCloseBtn = document.getElementById("mobileCloseBtn");

    sidebar.classList.remove("active");
    toggleButton.classList.remove("active");

    if (window.innerWidth <= 768) {
        toggleButton.style.display = "block";  // ✅ Show toggle again
        mobileCloseBtn.style.display = "none"; // ✅ Hide close button
    }
}

// ✅ Fetch Vehicle Details & Show Popup
function fetchVehicleDetails(deviceID) {
    if (!deviceID) {
        console.error("❌ Device ID is missing!");
        alert("❌ No Device ID found!");
        return;
    }

    console.log("🚀 Fetching details for Device ID:", deviceID);

    fetch(`/api/details/${deviceID}`)
        .then(response => {
            console.log("📡 Response Status:", response.status);
            if (!response.ok) {
                throw new Error("❌ Server returned error " + response.status);
            }
            return response.json();
        })
        .then(vehicle => {
            console.log("📡 Vehicle Details Received:", vehicle);

            if (!vehicle || Object.keys(vehicle).length === 0) {
                alert("❌ No data found for this vehicle!");
                return;
            }

            // ✅ Populate Popup Data
            document.getElementById("popup-deviceID").textContent = vehicle.deviceID || "N/A";
            document.getElementById("popup-serialno").textContent = vehicle.serialNo || "N/A";
            document.getElementById("popup-ownerName").textContent = vehicle.ownerName || "N/A";
            document.getElementById("popup-model").textContent = vehicle.model || "N/A";
            document.getElementById("popup-simnumber").textContent = vehicle.simNumber || "N/A";
            document.getElementById("popup-timeinterval").innerText = vehicle.timeIntervals || "N/A";

            // ✅ Show Popup
            document.getElementById("popupOverlay").style.display = "block";
            document.getElementById("vehicleDetailsModal").classList.add("show");
            console.log("✅ Popup Opened!");
        })
        .catch(error => {
            console.error("🚨 Error fetching vehicle details:", error);
            alert("⚠️ Error fetching data. Check console for details.");
        });
}

// ✅ Function to Close Popup
function closePopup() {
    const overlay = document.getElementById("popupOverlay");
    const modal = document.getElementById("vehicleDetailsModal");
    
    if (overlay) overlay.style.display = "none";
    if (modal) modal.classList.remove("show");
}

document.addEventListener("DOMContentLoaded", function () {
    const toggleButton = document.getElementById("toggleButton");
    const statusSummary = document.querySelector(".status-summary");

    if (!toggleButton || !statusSummary) return;

    // Initially hide the status summary
    statusSummary.style.display = "none";

    toggleButton.addEventListener("click", function () {
        // Toggle visibility of status summary
        statusSummary.style.display = 
            statusSummary.style.display === "none" ? "flex" : "none";
    });
});

// =========== MODIFY fetchDevicesByStatus TO FILTER ===========
let currentPage = 1;
const itemsPerPage = 10;

async function fetchDevicesByStatus(status, page = 1) {
    const popup = document.getElementById("deviceDetailsPopup");
    const title = document.getElementById("popup-title");
    const deviceList = document.getElementById("deviceList");

    title.textContent = `${status.toUpperCase()} Devices`;
    deviceList.innerHTML = "<li>Loading...</li>";

    try {
        const response = await fetch("/api/vehicle/last/latests-locations/all");
        if (!response.ok) throw new Error(`Server Error: ${response.status}`);

        const devices = await response.json();
        if (!Array.isArray(devices)) throw new Error("Invalid API response format.");

        const now = Date.now();

        // =========== FILTER BY ALLOWED DEVICES FIRST ===========
        const allowedDevices = CONFIG.allowedDeviceIDs.length > 0 
            ? devices.filter(device => {
                const deviceId = (device.deviceId || device.deviceID || '').trim().toUpperCase();
                return CONFIG.allowedDeviceIDs.includes(deviceId);
            })
            : devices;

        // Recompute statuses
        const processedDevices = allowedDevices.map(device => {
            const statusRaw = (device.vehicleStatus || "").toUpperCase();
            const timestamp = new Date(device.timestamp).getTime();
            const elapsedSec = (now - timestamp) / 1000;

            const [run, park, idle] = (device.timeIntervals || "0,0,0").split(',').map(x => +x || 0);

            let isOffline = false;

            if ((statusRaw === "RUNNING" || statusRaw === "MOVING") && run > 0) {
                if (elapsedSec > run) isOffline = true;
            }
            else if (statusRaw === "PARKED" && park > 0) {
                if (elapsedSec > park) isOffline = true;
            }
            else if (statusRaw === "IDLE" && idle > 0) {
                if (elapsedSec > idle) isOffline = true;
            }
            else {
                isOffline = true;
            }

            return {
                ...device,
                computedStatus: isOffline ? "OFFLINE" : statusRaw
            };
        });

        // Filter by computed status
        let filteredDevices = [];
        switch (status) {
            case "running":
                filteredDevices = processedDevices.filter(d => d.computedStatus === "RUNNING");
                break;
            case "idle":
                filteredDevices = processedDevices.filter(d => d.computedStatus === "IDLE");
                break;
            case "parked":
                filteredDevices = processedDevices.filter(d => d.computedStatus === "PARKED");
                break;
            case "lost":
                filteredDevices = processedDevices.filter(d => d.computedStatus === "OFFLINE");
                break;
            default:
                filteredDevices = processedDevices;
        }

        // Pagination
        const totalPages = Math.max(1, Math.ceil(filteredDevices.length / itemsPerPage));
        currentPage = Math.max(1, Math.min(page, totalPages));
        const startIdx = (currentPage - 1) * itemsPerPage;
        const endIdx = startIdx + itemsPerPage;
        const pageDevices = filteredDevices.slice(startIdx, endIdx);

        // Render
        deviceList.innerHTML = "";
        if (pageDevices.length === 0) {
            deviceList.innerHTML = "<li>No devices available</li>";
        } else {
            pageDevices.forEach(device => {
                const li = document.createElement("li");
                li.innerHTML = `<strong>${device.deviceId}</strong> - ${device.computedStatus}`;
                deviceList.appendChild(li);
            });
        }

        // Pagination controls
        const paginationControls = document.getElementById("paginationControls");
        paginationControls.innerHTML = `
            <button onclick="fetchDevicesByStatus('${status}', ${currentPage - 1})" ${currentPage === 1 ? "disabled" : ""}>⬅ Previous</button>
            <span>Page ${currentPage} of ${totalPages}</span>
            <button onclick="fetchDevicesByStatus('${status}', ${currentPage + 1})" ${currentPage === totalPages ? "disabled" : ""}>Next ➡</button>
        `;

        popup.style.display = "block";
    } catch (error) {
        console.error("🚨 Error fetching device data:", error);
        deviceList.innerHTML = `<li>Error: ${error.message}</li>`;
    }
}

function closeDevicePopup() {
    const popup = document.getElementById("deviceDetailsPopup");
    if (popup) {
        popup.style.display = "none";
    }
}

// Function to show speed alert popup
// Function to close the alert manually
function closeSpeedAlert() {
    document.getElementById("speedAlertPopup").style.display = "none";
}

// Function to determine speed class based on speed range
function closeSettingsSidebar() {
    let sidebar = document.getElementById("settingsSidebar");

    if (window.innerWidth < 768) {
        // Mobile: Slide down and hide
        sidebar.style.bottom = "-100%";
    } else {
        // Desktop: Slide out and hide
        sidebar.style.right = "-350px";
    }

    sidebar.classList.remove("active");

    // Hide completely after animation ends
    setTimeout(() => {
        sidebar.style.display = "none"; 
    }, 300); // Match transition duration
}
</script>

<script>
function zoomEffect(event, deviceId, latitude, longitude) {
    const lat = parseFloat(latitude);
    const lng = parseFloat(longitude);

    if (isNaN(lat) || isNaN(lng)) {
        console.error(`❌ Invalid coordinates for ${deviceId}: ${lat}, ${lng}`);
        return;
    }

    console.log(`📍 Zooming to ${deviceId} at (${lat}, ${lng})`);
    window.vehicleTracker.zoomToVehicle(deviceId, lat, lng);
}

document.getElementById("searchBar").addEventListener("input", function () {
    const searchValue = this.value.toLowerCase();
    const rows = document.querySelectorAll("#trackerTableBody tr");

    rows.forEach(row => {
        const deviceId = row.cells[1]?.textContent.toLowerCase() || ""; // ✅ 2nd column = Device ID
        row.style.display = deviceId.includes(searchValue) ? "" : "none";
    });
});
</script>

<script>
let currentSidebarPage = 1;
const sidebarRowsPerPage = 10;

function paginateSidebarTable() {
    const allRows = document.querySelectorAll("#trackerTableBody tr");
    const totalRows = allRows.length;
    const totalPages = Math.ceil(totalRows / sidebarRowsPerPage);

    // Hide all rows
    allRows.forEach(row => (row.style.display = "none"));

    // Show current page rows
    const start = (currentSidebarPage - 1) * sidebarRowsPerPage;
    const end = start + sidebarRowsPerPage;
    for (let i = start; i < end && i < totalRows; i++) {
        allRows[i].style.display = "";
    }

    // Create simple controls
    const paginationContainer = document.getElementById("sidebarPagination");
    paginationContainer.innerHTML = `
        <button onclick="goSidebarPage(-1)" ${currentSidebarPage === 1 ? "disabled" : ""}>⬅</button>
        <span>Page ${currentSidebarPage} of ${totalPages}</span>
        <button onclick="goSidebarPage(1)" ${currentSidebarPage === totalPages ? "disabled" : ""}>➡</button>
    `;
}

function goSidebarPage(direction) {
    const allRows = document.querySelectorAll("#trackerTableBody tr");
    const totalPages = Math.ceil(allRows.length / sidebarRowsPerPage);
    currentSidebarPage = Math.max(1, Math.min(currentSidebarPage + direction, totalPages));
    paginateSidebarTable();
}

function refreshSidebarTableWithPagination(data) {
    window.vehicleTracker.updateSidebarTable(data);
    currentSidebarPage = 1;
    paginateSidebarTable();
}

function formatUtcTime(ts) {
    const d = new Date(ts);
    return d.toISOString().replace('T',' ').substr(0,19);
}
</script>

<script>
// ----------------------
// OFFLINE ALERTS
// ----------------------
// =========== MODIFY checkVehicleAlerts TO FILTER ===========
function checkVehicleAlerts() {
    fetch('/api/vehicle/last/latests-locations/all')
        .then(res => res.json())
        .then(data => {
            const now = Date.now();
            const alertsToShow = [];

            // =========== FILTER BY ALLOWED DEVICES ===========
            const filteredData = CONFIG.allowedDeviceIDs.length > 0 
                ? data.filter(vehicle => {
                    const deviceId = (vehicle.deviceId || vehicle.deviceID || '').trim().toUpperCase();
                    return CONFIG.allowedDeviceIDs.includes(deviceId);
                })
                : data;

            filteredData.forEach(vehicle => {
                const id = vehicle.deviceId;
                if (!id) return;

                const ts = new Date(window.deviceTimestamps?.[id] || vehicle.timestamp).getTime();
                const elapsedSec = (now - ts) / 1000;

                const [run, park, idle] = (vehicle.timeIntervals || "0,0,0")
                    .split(',').map(n => +n || 0);

                let isOffline = false;
                const st = (vehicle.vehicleStatus || "").toUpperCase();
                if ((st === "RUNNING" || st === "MOVING") && run > 0) {
                    isOffline = elapsedSec > run;
                } else if (st === "PARKED" && park > 0) {
                    isOffline = elapsedSec > park;
                } else if (st === "IDLE" && idle > 0) {
                    isOffline = elapsedSec > idle;
                } else {
                    isOffline = true;
                }

                // only alert once per timestamp
                const lastAlertTs = offlineAlertTracker.get(id) || 0;
                if (isOffline && ts > lastAlertTs) {
                    alertsToShow.push({ id, ts });
                    offlineAlertTracker.set(id, ts);
                }
            });

            // if there are alerts, show them one‐by‐one
            let i = 0;
            function showNext() {
                if (i >= alertsToShow.length) return;
                const { id, ts } = alertsToShow[i++];
                const offlineMs = now - ts;
                const duration = formatDuration(offlineMs);
                const since = formatUtc(ts);

                Swal.fire({
                    toast: true,
                    position: 'bottom-start',          // bottom-right
                    icon: 'error',
                    title: `🔌 Vehicle Offline`,
                    html: `<strong>${id}</strong><br>
                            <small>Since: ${since}</small><br>
                            <small>Dur: ${duration}</small>`,
                    showConfirmButton: false,
                    timer: 8000,
                    timerProgressBar: true,
                    customClass: { popup: 'swal2-offline-toast' }
                }).then(showNext);
            }
            showNext();
        })
        .catch(console.error);
}

// helper to format ms → "X hr Y min Z sec"
function formatDuration(ms) {
    let totalSec = Math.floor(ms / 1000);

    const days = Math.floor(totalSec / 86400);
    totalSec %= 86400;

    const hours = Math.floor(totalSec / 3600);
    totalSec %= 3600;

    const minutes = Math.floor(totalSec / 60);
    const seconds = totalSec % 60;

    const parts = [];
    if (days)    parts.push(`${days} day${days > 1 ? 's' : ''}`);
    if (hours)   parts.push(`${hours} hr`);
    if (minutes) parts.push(`${minutes} min`);
    if (seconds) parts.push(`${seconds} sec`);

    return parts.length ? parts.join(' ') : '0 sec';
}

// helper to format UTC timestamp
function formatUtc(ts) {
    const d = new Date(ts);
    return d.toISOString().replace('T',' ').slice(0,19);
}

// track last‐alert per device
const offlineAlertTracker = new Map();

// kick it off every 1 second:
checkVehicleAlerts();
setInterval(checkVehicleAlerts, 1000);

function triggerIdleAlert(deviceId, durationStr, timestamp, vehicle = {}) {
    const time = formatUtc(timestamp);
    const flag = vehicle.countryCode ? `<img src="https://flagcdn.com/24x18/${vehicle.countryCode.toLowerCase()}.png">` : '';
    const vehicleNumber = vehicle.deviceId || "N/A";
    const driver = vehicle.driverName || "N/A";

    Swal.fire({
        title: '🛑 Idle Alert',
        html: `${flag} <strong>${deviceId}</strong><br><strong>Idle Duration:</strong> ${durationStr}`,
        icon: 'warning',
        timer: 10000,
        showConfirmButton: false
    });
    playAlertSound();
}

function updateOfflineAlertSidebar(deviceId, milestone) {
    const list = document.getElementById("offlineAlertList");
    if (!list) return;

    const liId = `offline-${deviceId}`;
    const existing = document.getElementById(liId);
    const text = `Device: ${deviceId} – Offline ≥ ${milestone} min`;

    if (existing) {
        existing.textContent = text;
    } else {
        const li = document.createElement("li");
        li.id = liId;
        li.className = "list-group-item list-group-item-danger";
        li.textContent = text;
        list.appendChild(li);
    }
}

function triggerBackOnlineAlert(deviceId, vehicle) {
    Swal.fire({
        title: "✅ Vehicle Back Online",
        html: `<strong>${deviceId}</strong> is now reporting.`,
        icon: "success",
        timer: 5000,
        showConfirmButton: false
    });
}

function updateIdleAlertSidebar(deviceId, milestone) {
    const list = document.getElementById("idleAlertList");
    if (!list) return;

    const liId = `idle-${deviceId}`;
    const existing = document.getElementById(liId);
    const text = `Device: ${deviceId} – IDLE ≥ ${milestone} min`;

    if (existing) {
        existing.textContent = text;
    } else {
        const li = document.createElement("li");
        li.id = liId;
        li.className = "list-group-item list-group-item-warning";
        li.textContent = text;
        list.appendChild(li);
    }
}

function formatDuration(ms) {
    const totalSec = Math.floor(ms / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    if (h > 0) return `${h} hr ${m} min ${s} sec`;
    if (m > 0) return `${m} min ${s} sec`;
    return `${s} sec`;
}

function formatUtc(ts) {
    const d = new Date(ts);
    return d.getUTCFullYear() + '-' +
        String(d.getUTCMonth() + 1).padStart(2, '0') + '-' +
        String(d.getUTCDate()).padStart(2, '0') + ' ' +
        String(d.getUTCHours()).padStart(2, '0') + ':' +
        String(d.getUTCMinutes()).padStart(2, '0') + ':' +
        String(d.getUTCSeconds()).padStart(2, '0');
}

function playAlertSound() {
    const audio = document.getElementById("overspeedAudio");
    if (audio) {
        audio.currentTime = 0;
        audio.play().catch(err => console.warn("🔇 Sound error:", err));
    }
}
</script>

<script>
let isMuted = false;

document.getElementById("muteToggleBtn").addEventListener("click", () => {
    isMuted = !isMuted;
    const btn = document.getElementById("muteToggleBtn");
    btn.textContent = isMuted ? "🔈 Unmute" : "🔇 Mute";
});

function playAlertSound() {
    if (isMuted) return;

    const audio = document.getElementById("overspeedAudio");
    if (audio) {
        audio.currentTime = 0;
        audio.play().catch(err => console.warn("🔇 Alert sound failed:", err));
    }
}
</script>

<script>
function showSidebarTab(tabId, btn) {
    document.querySelectorAll('.custom-tab-content').forEach(div => div.classList.remove('active'));
    document.querySelectorAll('.custom-tab-btn').forEach(b => b.classList.remove('active'));

    document.getElementById(tabId).classList.add('active');
    btn.classList.add('active');
}

function refreshAll() {
    console.log("🔄 Refreshing all GPS data...");
    autoRefreshData();       // Updates vehicle markers and status count
    autoRefreshSidebar();    // Updates sidebar table
    checkVehicleAlerts();    // ✅ Triggers offline/idle alerts
}

function generateGSMBars(strength) {
    const level = strength <= 30 ? 1 : strength <= 70 ? 2 : 3;
    let bars = "";

    for (let i = 1; i <= 3; i++) {
        bars += `<span class="bar ${i <= level ? 'filled' : ''}"></span>`;
    }
    return bars;
}
</script>



<script>
document.addEventListener("DOMContentLoaded", function () {
    const sidebar = document.getElementById("sidebar");
    const toggleButton = document.getElementById("toggleButton");
    const mobileCloseBtn = document.getElementById("mobileCloseBtn");

    // ✅ Global visibility manager
    window.updateToggleVisibility = function () {
        const isSidebarOpen = sidebar.classList.contains("active");
        const isMobile = window.innerWidth <= 768;

        if (isMobile) {
            toggleButton.style.display = isSidebarOpen ? "none" : "block";
            mobileCloseBtn.style.display = isSidebarOpen ? "block" : "none";
        } else {
            toggleButton.style.display = "block";
            mobileCloseBtn.style.display = "none";
        }
    };

    toggleButton.addEventListener("click", function () {
        sidebar.classList.toggle("active");
        toggleButton.classList.toggle("active");
        updateToggleVisibility();
    });

    // ✅ Global sidebar close handler
    window.closeSidebar = function () {
        sidebar.classList.remove("active");
        toggleButton.classList.remove("active");
        updateToggleVisibility();
    };

    window.addEventListener("resize", updateToggleVisibility);

    // Initial run
    updateToggleVisibility();
});

function formatTimeIntervals(intervalStr) {
    if (!intervalStr || typeof intervalStr !== 'string') return 'N/A';
    const [run, park, idle] = intervalStr.split(',').map(val => parseInt(val) || 0);

    function formatSec(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        if (h > 0) return `${h}h ${m}m ${s}s`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    return `Running: ${formatSec(run)}, Parked: ${formatSec(park)}, Idle: ${formatSec(idle)}`;
}
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
